<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/tachyons/css/tachyons.min.css">
<style>
    .wrapper {
        display: flex;
        flex-direction: column;
        /*height: 100vh;*/
        align-items: center;
        justify-content: space-between;
    }
    .hidden {
        visibility: hidden;
    }
</style>

<body class="sans-serif pa2 bg-navy" style="height: 100%;">

    <div class="wrapper">
        <div>
            <h1 class="lightest-blue">LED Board Simulator</h1>
            <div id="board-lights" class="absolute"></div>
            <div id="board"></div>
        </div>

        <!-- <audio id="musicPlayer" autoplay loop>
            <source src="parallaxing_atmosphere.mp3" type="audio/mpeg">
        </audio> -->
    </div>

    <script>

        //** Variables and setup **//
        // generate an alphabet
        let alphabet = "abcdefghijklmnopqrstuvwxyz".split('');
        // let shipLocation = null;
        let bulletLocation = null;
        let bulletFired = false;
        let shipColor = "";
        let fps = 30;
        let frame = 0;
        let grid = {height: 16, width: 32};

        const ledColor = "bg-dark-blue";

        // document.getElementById("musicPlayer").volume = 0.5;



        //** LED Board **//

        // Build 16 rows with 32 divs
        function getBoard(boardName, ledName, defaultColor = "") {

            let hidden = "";

            if (ledName == "light") {
                hidden = "hidden";
            }

            for (r = 0; r < grid.height; r++) { 
                let currentRow = 'row-' + alphabet[r];
                document.getElementById(boardName).innerHTML += "<div id='row-" + alphabet[r] + "'></div>";
        
                for (c = 0; c < grid.width; c++) {
                    document.getElementById(currentRow).innerHTML += "<div id='" + alphabet[r] + c + "-" + ledName + "' class='dib pa1 ma1 br-100 " + hidden + " " + defaultColor + "'></div>";
                }
            }
        }

        // Turn on a single light
        function turnOn(location, color) {
            document.getElementById(location.row + location.column + "-light").classList.add(color);
            document.getElementById(location.row + location.column + "-light").classList.remove("hidden");
        }

        // Turn off a single light
        function turnOff(location) {
            document.getElementById(location.row + location.column + "-light").classList.add("hidden");
        }

        


        // Bullet shot light effect
        function bullet(shipLocation, color, speed) {
            console.log("shot fired");

            let bulletFiredLocation = shipLocation.column;

            for (i = bulletFiredLocation; i < grid.width; i++) {
                bulletFired = true;

                setTimeout(function(led) {
                    bulletLocation = new Location(shipLocation.row, led);

                    if (bulletLocation.column == grid.width - 1) {
                        setTimeout(function() {
                            bulletFired = false;
                        }, speed);
                    }
                }.bind(null, i), i * speed);
            }    
        }




        //** Ship creation and movement **//

        function moveShipDown() {
            let shipRow = alphabet.indexOf(shipLocation.row);

            if (shipRow < 15) {
                shipRow = shipRow + 1;
                shipLocation.row = alphabet[shipRow];
            }
        }


        /** Classes **/

        // Make a ship class that has a constructor that takes arguments of initialLocation

        class Location {
            constructor(row, column) {
                this.row = row;
                this.column = column;
            }
        }

        class Ship {
            constructor(location, color) {
                this.location = location;
                this.color = color;
            }

            moveUp() {
                let shipRow = alphabet.indexOf(this.location.row);

                if (shipRow > 0) {
                    shipRow = shipRow - 1;
                    this.location.row = alphabet[shipRow];
                }
            }

            moveDown() {
                let shipRow = alphabet.indexOf(this.location.row);

                if (shipRow < 15) {
                    shipRow = shipRow + 1;
                    this.location.row = alphabet[shipRow];
                }
            }

            moveLeft() {
                let shipColumn = this.location.column;

                if (shipColumn > 0) {
                    shipColumn = shipColumn - 1;
                    this.location.column = shipColumn;
                }
            }

            moveRight() {
                let shipColumn = this.location.column;

                if (shipColumn < 31) {
                    shipColumn = shipColumn + 1;
                    this.location.column = shipColumn;
                }
            }
        }

        //** Instructions **//

        getBoard("board", "slot", "bg-dark-blue");
        getBoard("board-lights", "light");

        let myShip = new Ship(new Location("i", 0), "bg-yellow");



        // 1) Create an array of game objects, which define their position and color
        // for loop through all objects...
        // turn on leds accordingly.. if there is nothing in that space turn the led off

        // turn on light based on fps between 1 (every frame) and 30 (once every 30 frames or once a second)
        // if (frame % 2 === 0) {
        //     turnOn(new Location("d", 15), "bg-yellow");
        // } else {
        //     turnOff(new Location("d", 15));
        // }
        // frame++;

        function render(myShip) {

            // cleanup all unused lights
            for (r = 0; r < grid.height; r++) { 
                for (c = 0; c < grid.width; c++) {
                    let led = (new Location(alphabet[r], c))
                    turnOff(led);
                }
            }

            turnOn(myShip.location, myShip.color);

            turnOn(new Location("f", 8), "bg-white");

            if (bulletFired) {
                turnOn(bulletLocation, "bg-red");
            }

        }

        setInterval(render.bind(null, myShip), 1000 / fps);

        // keyboard controls
        document.onkeydown = function(e) {
            switch (e.keyCode) {
                case 32:
                    bullet(myShip.location, "bg-red", 30);
                    break;
                case 38: // up
                    myShip.moveUp();
                    break;
                case 87: // w
                    myShip.moveUp();
                    break;
                case 40: // down
                    myShip.moveDown();
                    break;
                case 83: // s
                    myShip.moveDown();
                    break;
                case 37: // left
                    myShip.moveLeft();
                    break;
                case 39: // right
                    myShip.moveRight();
                    break;
            }
        };


        //**  Test FPS **//

        // setTimeout(function() {
        //     clearInterval(go);
        // }, 1000);



        //** Test commands **//

        /*
        turnOn(new Location("b", 24), "bg-red");

        lightsOn("bg-yellow");
        setTimeout(function() { lightsOff() }, 3000);

        blink("i15", "bg-red", 500, 1000);
        blink("i16", "bg-yellow", 500, 1500);
        blink("i17", "bg-green", 500, 2000);
        

        // Turn on all the lights
        function lightsOn(color) {
            console.log("lights on");

            for (r = 0; r < 16; r++) {
                for (c = 0; c < 32; c++) {document.getElementById(alphabet[r] + c).classList.add(color);
                    document.getElementById(alphabet[r] + c).classList.remove(ledColor);
                }
            }
        };

        // Turn all the lights off
        function lightsOff() {
            console.log("lights off");

            for (r = 0; r < 16; r++) {
                for (c = 0; c < 32; c++) {
                    document.getElementById(alphabet[r] + c).classList.add(ledColor);
                    document.getElementById(alphabet[r] + c).classList.remove(color);
                }
            }
        }

        // Turn a light on then back off
        function blink(led, color, duration, delay) {
            setTimeout(function() {
                turnOn(null, led, color);
                document.getElementById(led).classList.add(color);
                document.getElementById(led).classList.remove(ledColor);

                setTimeout(function() {
                    document.getElementById(led).classList.add(ledColor);
                    document.getElementById(led).classList.remove(color);
                }, duration);
            }, delay);
        }
        */

    </script>

</body>